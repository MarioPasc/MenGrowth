raw_data:
  # Study name to study number mappings
  # These define how directory names map to standardized study numbers
  study_mappings:
    # Source baseline study
    baseline: "0"

    # Extension studies (Spanish ordinals)
    primera: "0"
    primero: "0"
    primera1: "0"
    primero1: "0"
    segunda1: "1"
    segundo1: "1"
    segunda: "1"
    segundo: "1"
    tercera: "2"
    tercero: "2"
    cuarta: "3"
    cuarto: "3"
    quinta: "4"
    quinto: "4"
    sexta: "5"
    sexto: "5"
    septima: "6"
    septimo: "6"
    octava: "7"
    octavo: "7"
    novena: "8"
    noveno: "8"
    decima: "9"
    decimo: "9"
    undecima: "10"
    undecimo: "10"

    # Control studies
    control1: "1"
    control2: "2"
    control3: "3"
    control4: "4"
    control5: "5"
    control6: "6"
    control7: "7"
    control8: "8"
    control9: "9"
    control10: "10"

  # Modality name synonyms for file standardization
  # Maps various naming conventions to standardized modality names
  modality_synonyms:
    # FLAIR variants
    t2f:
      - FLAIR
      - flair
      - Flair
      - FLAIR-sequence
      - flair-sequence
      - t2f
      - T2-FLAIR
      - T2flair

    # T1 pre-contrast (sin contraste) variants
    t1n-axial:
      - T1pre-axial
      - T1-axial
      - T1sin-axial
      - T1AX
      - T1AXIAL
    t1n-sagital:
      - T1pre-sagital
      - T1-sagital
      - T1sin-sagital
      - T1SAG
    t1n-coronal:
      - T1pre-coronal
      - T1-coronal
      - T1sin-coronal
      - T1COR
      - T1CORONAL
    t1n:
      - T1pre
      - T1-pre
      - T1SIN
      - T1sin
    # T1 post-contrast (contrast-enhanced) variants
    t1c-axial:
      - T1ce-axial
      - T1post-axial
      - T1-axial
      - T1-CE-axial
    t1c-sagital:
      - T1ce-sagital
      - T1post-sagital
      - T1-sagital
    t1c-coronal:
      - T1ce-coronal
      - T1post-coronal
      - T1-coronal
    t1c:
      - T1ce
      - T1-ce
      - T1post
      - T1-post
      - T1
    # T2 variants
    t2w-stargre:
      - T2starGRE
      - T2-STIR
      - T2STIR
      - T2-stir
      - T2stir
    t2w-spinecho:
      - T2-SE
      - T2SE
      - T2-spinecho
      - T2spinecho
    t2w:
      - T2
      - t2
      - T2-weighted

    # SWI variants
    swi:
      - SWI
      - swi
      - Swi
      - SUSC
      - susc
      - susceptibility

    # Diffusion variants
    dwi:
      - DWI
      - dwi
      - DIFUSION1
      - DIFUSION2
      - DIFUSION3
      - Diffusion
      - DIFUSION

    # ADC (Apparent Diffusion Coefficient)
    adc:
      - ADC
      - adc

    ct:  
      - TC
      - Ct
      - ct
      - TOMOGRAFIA
      - TOMOGRAFIA-COMPUTARIZADA
      - TOMOGRAFIA_COMPUTARIZADA

  # File exclusion patterns (glob patterns)
  # Files matching these patterns will NOT be copied
  exclusion_patterns:
    - "*seg*.nrrd"      # Segmentation files
    - "*_seg.nrrd"      # Segmentation files (alternative naming)
    - "*.h5"            # Transform files
    - "*.dcm"           # DICOM files
    - "*.seq.nrrd"      # Sequence files (if not needed)
    - "*.txt"           # Text files
    - "*.xlsx"          # Excel metadata files
    - "*.csv"           # CSV metadata files
    - "*.log"           # Log files
    - "*_mask.nrrd"     # Mask files
    - "*_label.nrrd"    # Label files
    - "*Survey*.nrrd"  # Survey files
    - "*COLSAG*.nrrd"  # Localizer files
    - "*VsT1W*.nrrd"  # Previous T1-weighted files
    - "*disc*" # Hand-selected discards

  # Output folder structure template
  output_structure: "{output_root}/MenGrowth-2025/P{patient_id}/{study_number}"

  # Input data source types
  input_sources:
    - source/baseline/RM     # Resonancia Magnética with modality subfolders
    - source/baseline/TC     # Tomografía Computarizada (or Contrast)
    - source/controls        # Control/follow-up studies
    - extension_1            # Extension cohort

  # Filtering configuration
  # Applied after reorganization to ensure data quality and completeness
  filtering:
    # Required sequences for final dataset
    sequences: [t1c, t1n, t2f, t2w]

    # Maximum number of missing sequences allowed per study
    # Example: if 1, studies can be missing at most 1 sequence from the required list
    allowed_missing_sequences_per_study: 1

    # Minimum number of longitudinal studies required per patient
    # Patients with fewer studies will be removed entirely
    min_studies_per_patient: 2

    # Orientation priority for selecting sequences when multiple orientations exist
    # Format: priority order from highest to lowest
    # 'none' = exact match (e.g., t1c.nrrd), others match suffixed versions (e.g., t1c-axial.nrrd)
    # Example: if t1c is missing but t1c-axial and t1c-sagital exist, t1c-axial is selected and renamed to t1c
    orientation_priority: [none, axial, sagital, coronal]

    # Whether to keep only the required sequences in the final dataset
    keep_only_required_sequences: true

    # Whether to re-identify patients with new anonymized IDs, we will also save a JSON mapping file from old to new IDs
    reid_patients: true

  # Clinical metadata configuration
  # Processes clinical metadata from xlsx and tracks patient inclusion/exclusion
  metadata:
    # Path to the clinical metadata xlsx file (will NOT be modified)
    xlsx_path: "/media/mpascual/PortableSSD/Meningiomas/MenGrowth/raw/source/Meningioma_Adquisition/metadata.xlsx"

    # Enable metadata processing during curation
    enabled: true

    # Output filename for enriched CSV (with included, exclusion_reason, MenGrowth_ID columns)
    output_csv_name: "metadata_enriched.csv"

    # Output filename for clean JSON metadata
    output_json_name: "metadata_clean.json"

    # Log warnings for patients in data but not in metadata
    warn_missing_metadata: true

  # Quality filtering configuration
  # Applied after basic filtering to ensure data quality for preprocessing
  quality_filtering:
    # Master switch to enable/disable all quality filtering
    enabled: true

    # When true, remove studies/patients with blocking quality issues
    remove_blocked: true

    # Minimum clean studies required to keep a patient (otherwise patient is removed)
    min_studies_per_patient: 2

    # A1: NRRD Header Validation
    # Validates NRRD file format and required headers
    nrrd_validation:
      enabled: true
      require_3d: true           # Reject 4D timeseries or 2D slices
      require_space_field: true  # Require orientation metadata

    # A2: Scout/Localizer Detection
    # Detects and rejects low-resolution scout/localizer images
    # Note: 2D multi-slice acquisitions (T2W, FLAIR) typically have 15-50 slices
    scout_detection:
      enabled: true
      min_dimension_voxels: 10   # Minimum voxels per axis (lowered for 2D multi-slice)
      max_slice_thickness_mm: 8.0  # Maximum slice thickness (raised for thick-slice FLAIR)

    # A3: Voxel Spacing Validation
    # Validates voxel spacing is within reasonable bounds
    # Note: 2D multi-slice acquisitions have high anisotropy (5-6.5mm slice, 0.4mm in-plane)
    voxel_spacing:
      enabled: true
      min_spacing_mm: 0.2        # Minimum voxel size (mm)
      max_spacing_mm: 7.0        # Maximum voxel size (mm) - raised for thick-slice 2D
      max_anisotropy_ratio: 20.0 # Maximum anisotropy - raised for 2D multi-slice
      action: "warn"             # "warn" or "block"

    # B1: SNR-Based Filtering
    # Filters images based on signal-to-noise ratio
    # Uses corner-based noise estimation with modality-specific thresholds
    snr_filtering:
      enabled: true
      min_snr: 5.0               # Fallback SNR threshold
      method: "corner"           # "corner" or "background_percentile"
      corner_cube_size: 10       # Voxel cube size for corner sampling
      modality_thresholds:       # Per-modality SNR thresholds
        t1c: 8.0
        t1n: 6.0
        t2w: 5.0
        t2f: 4.0
      action: "block"            # "warn" or "block"

    # B2: Contrast Detection
    # Detects all-black, all-white, or uniform images
    contrast_detection:
      enabled: true
      min_std_ratio: 0.10        # Minimum std/mean ratio
      max_uniform_fraction: 0.95 # Maximum fraction of voxels with same value
      action: "block"            # "warn" or "block"

    # B3: Intensity Outlier Detection
    # Detects NaN, Inf, or extreme intensity values
    # Per-modality thresholds (FLAIR naturally has higher outlier ratios)
    intensity_outliers:
      enabled: true
      reject_nan_inf: true       # Immediately reject files with NaN/Inf
      max_outlier_ratio: 10.0    # Fallback max_intensity / 99th percentile
      modality_thresholds:       # Per-modality outlier ratio thresholds
        t1c: 10.0
        t1n: 15.0
        t2w: 12.0
        t2f: 30.0
      action: "warn"             # "warn" or "block"

    # B4: Motion Artifact Detection
    # Detects motion/blurring via gradient entropy analysis
    motion_artifact:
      enabled: true
      min_gradient_entropy: 3.0  # Minimum gradient histogram entropy (bits)
      action: "warn"             # "warn" or "block"

    # B5: Ghosting Detection
    # Detects ghosting artifacts via corner signal intensity
    ghosting_detection:
      enabled: true
      max_corner_to_foreground_ratio: 0.15  # Max corner/foreground mean ratio
      corner_cube_size: 10       # Voxel cube size for corner sampling
      action: "warn"             # "warn" or "block"

    # C1: Affine Matrix Validation
    # Validates affine transformation matrix
    # Note: determinant ~ voxel volume in mm³ (high-res data has small determinants)
    affine_validation:
      enabled: true
      min_det: 0.01              # Minimum determinant - lowered for high-res (0.24mm) data
      max_det: 100.0             # Maximum determinant (reasonable scaling)
      action: "block"            # "warn" or "block"

    # C2: Field-of-View Consistency
    # Checks for asymmetric FOV that would cause issues with cubic padding
    fov_consistency:
      enabled: true
      warn_ratio: 3.0            # Warn if max_dim/min_dim > this
      block_ratio: 5.0           # Block if max_dim/min_dim > this

    # C3: Orientation Consistency Within Study
    # Checks if all modalities in a study have consistent orientation
    orientation_consistency:
      enabled: true
      action: "warn"             # "warn" or "block"

    # C4: Brain Coverage Validation
    # Checks minimum physical extent to ensure full brain coverage
    brain_coverage:
      enabled: true
      min_extent_mm: 100.0       # Minimum physical extent per axis (mm)
      action: "block"            # "warn" or "block"

    # D1: Temporal Ordering Validation
    # Validates study IDs reflect proper temporal ordering
    temporal_ordering:
      enabled: true
      action: "warn"             # Always warn-only (no blocking)

    # D3: Modality Consistency Across Timepoints
    # Checks if all timepoints have same modalities
    modality_consistency:
      enabled: false             # Disabled by default (stricter requirement)
      action: "warn"             # "warn" or "block"

    # E1: Registration Reference Availability
    # Ensures at least one reference modality exists for registration
    registration_reference:
      enabled: true
      priority: "t1n > t1c > t2f > t2w"  # Reference modality priority
      action: "block"            # "warn" or "block"