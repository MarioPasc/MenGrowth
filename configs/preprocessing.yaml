preprocessing:
  data_harmonization:
    enabled: true

    # Selection
    patient_selector: "single"        # "single" | "all"
    patient_id: "MenGrowth-0015"      # used only if patient_selector == "single"

    # I/O mode
    mode: "test"                       # "test" | "pipeline"
    dataset_root: "/media/mpascual/PortableSSD/Meningiomas/MenGrowth/raw/MenGrowth-2025"
    output_root: "/media/mpascual/PortableSSD/Meningiomas/MenGrowth/preprocessed/MenGrowth-2025"     # used in test mode
    preprocessing_artifacts_path: "/media/mpascual/PortableSSD/Meningiomas/MenGrowth/preprocessed/artifacts"  # intermediate artifacts
    viz_root: "/media/mpascual/PortableSSD/Meningiomas/MenGrowth/preprocessed/viz"              # quick-looks for both modes
    overwrite: true                                                   # guard rails

    # Modalities to include (if present in a study directory)
    modalities: ["t1c", "t1n", "t2w", "t2f"]

    step0_data_harmonization:
        save_visualization: true # Save this step's visualization for the method used

        # Orientation
        reorient_to: "RAS"                 # "RAS" | "LPS"

        # Background zeroing (conservative)
        background_zeroing:
          method: null # "border_connected_percentile" | "self_head_mask" | null

          # if method == "border_connected_percentile"
          percentile_low: 2              # [0.1-2.0], conservative default
          gaussian_sigma: 0.5              # smoothing before thresholding (vox)
          min_comp_voxels: 500             # ignore tiny components

          # if method == "self_head_mask"
          auto_fallback: true        # dejar en true
          fallback_threshold: 0.05   # 5% del volumen; no tocar salvo necesidad
          fill_value: 0.0            # intensidad de fondo

          # if method is either one or the other
          air_border_margin: 0             # voxels to erode the air mask (MORE conservative - shrinks air region)
          expand_air_mask: 3               # voxels to dilate the air mask (LESS conservative - expands air region)
          # Note: Use EITHER air_border_margin OR expand_air_mask, not both > 0

    step1_bias_field_correction:
        save_visualization: true # Save visualization for bias field correction
        save_artifact: true      # Save bias field NIfTI to artifacts directory

        # Bias field correction parameters
        bias_field_correction:
          method: "n4"                     # "n4" | null (null to skip)
          shrink_factor: 4                 # Downsampling factor [1-8], higher=faster but coarser
          max_iterations: [50, 50, 50, 50] # Iterations per resolution level (4 levels)
          bias_field_fwhm: 0.15            # Gaussian smoothing FWHM [0.01-1.0], higher=smoother field
          convergence_threshold: 0.001     # Early stopping threshold (0.0-1.0)
