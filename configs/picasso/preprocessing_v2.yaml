# ============================================================================
# MenGrowth Preprocessing — Picasso v2 (skull-strip-first variant)
# ============================================================================
#
# Key changes from v1:
#   1. Step order: skull_stripping BEFORE registration_static
#      Rationale: Meningiomas are extra-axial and can distort skull geometry.
#      Brain-only registration focuses the optimizer on parenchyma, not scalp/bone.
#      HD-BET typically retains meningiomas in the brain mask (dura-attached).
#
#   2. Resampling: composite (BSpline + ECLARE)
#      Rationale: Clinical meningioma MRI often has thick slices (3-6mm through-plane)
#      but fine in-plane resolution (0.5-1mm). Composite applies BSpline for
#      near-isotropic dimensions and ECLARE for thick slabs — best of both worlds.
#      REQUIREMENT: `eclare` conda env must be installed on Picasso.
#      FALLBACK: Change method to "bspline" if ECLARE is unavailable.
#
#   3. Registration interpolation: Linear for intra-study/atlas (brain-only safety)
#      Rationale: After skull stripping, images have a sharp brain→0 discontinuity.
#      BSpline (order 3) uses a 4-voxel kernel that creates ringing artifacts at
#      this boundary. Linear avoids ringing. For Rigid+Affine transforms the
#      interior quality difference is negligible.
#      BSpline is kept for longitudinal registration where interior accuracy matters.
#
#   4. Atlas: must be brain-only (T1_brain.nii, not T1.nii)
#      If only full-head T1.nii is available, skull-strip it once with HD-BET.
#
#   5. Intensity normalization: z-score with clip_range [-5, 5]
#      Prevents extreme outliers from affecting downstream models (BraTS/nnU-Net convention).
#
# ============================================================================

preprocessing:
  # ── Pipeline step order ──
  # v1: ... registration → skull_stripping ...
  # v2: ... skull_stripping → registration ...   (CHANGED)
  steps: ["data_harmonization",
          "bias_field_correction",
          "resampling",
          "cubic_padding",
          "skull_stripping",
          "registration_static",
          "intensity_normalization",
          "longitudinal_registration"
          ]

  general_configuration:
    enabled: true

    # Selection
    patient_selector: "all"        # "single" | "all"
    patient_id: "MenGrowth-0006"   # used only if patient_selector == "single"

    # I/O mode
    mode: "test"                       # "test" | "pipeline"
    dataset_root: "/mnt/home/users/tic_163_uma/mpascual/fscratch/datasets/meningiomas/dataset/MenGrowth-2025"
    output_root: "/mnt/home/users/tic_163_uma/mpascual/fscratch/datasets/meningiomas/dataset/preprocessed_v2"
    preprocessing_artifacts_path: "/mnt/home/users/tic_163_uma/mpascual/execs/mengrowth-dataset/artifacts_v2"
    viz_root: "/mnt/home/users/tic_163_uma/mpascual/execs/mengrowth-dataset/viz_v2"
    overwrite: true

    # Modalities to include (if present in a study directory)
    modalities: ["t1c", "t1n", "t2w", "t2f"]

  # ============================================================================
  # Step-specific configurations
  # ============================================================================
  step_configs:

    # ========================================================================
    # Step 1: Data Harmonization (modality-level)
    # ========================================================================
    # NRRD → NIfTI conversion, RAS reorientation, optional background removal.
    # No changes from v1. background_zeroing is null because HD-BET expects
    # full-head input — don't remove background before skull stripping.
    data_harmonization:
      save_visualization: true

      reorient_to: "RAS"                 # Standard for ANTs. "LPS" for ITK convention.

      background_zeroing:
        method: null                     # null = skip (let skull stripping handle brain extraction)

        # Parameters below are inactive when method=null but kept for reference.
        percentile_low: 2
        gaussian_sigma: 0.5
        min_comp_voxels: 500
        auto_fallback: true
        fallback_threshold: 0.05
        fallback_method: "otsu"
        fallback_percentile: 10.0
        fill_value: 0.0
        air_p_low: 2.0
        air_p_high: 20.0
        air_p_global: 0.2
        erode_vox: 1
        close_iters: 2
        connectivity: 2
        air_border_margin: 0
        expand_air_mask: 3
        gaussian_sigma_px: 1.0
        n_components_to_keep: 1
        relaxed_threshold_factor: 0.1
        p_low: 1.0
        p_high: 99.0

    # ========================================================================
    # Step 2: Bias Field Correction (modality-level)
    # ========================================================================
    # N4ITK removes low-frequency intensity non-uniformity (RF coil inhomogeneity).
    # Parameters are ITK recommended defaults — no changes needed.
    #
    # shrink_factor=4: Downsample 4x for speed. The bias field is spatially smooth
    #   so 4x is fine. Increase to 2 for very small FOV or high-quality requirement.
    # max_iterations=[50,50,50,50]: 4 resolution levels, 50 iters each. Standard.
    # bias_field_fwhm=0.15: Controls smoothness of the estimated bias field.
    #   Higher = smoother field, prevents overfitting. 0.15 is conservative.
    # convergence_threshold=0.001: Stop if field change < 0.1%. Standard.
    bias_field_correction:
      save_visualization: true
      save_artifact: true              # Useful for QC: inspect the estimated bias field

      bias_field_correction:
        method: "n4"                   # Only option. Set null to skip entirely.
        shrink_factor: 4               # [1-8]. 4 = standard. 2 = more precise, 2x slower.
        max_iterations: [50, 50, 50, 50]   # Per-level. More = diminishing returns.
        bias_field_fwhm: 0.15          # [0.01-1.0]. 0.15 = standard for brain MRI.
        convergence_threshold: 0.001   # [0.0001-0.01]. 0.001 = standard.

    # ========================================================================
    # Step 3: Resampling (modality-level)                          *** CHANGED ***
    # ========================================================================
    # CHANGED: composite → bspline
    #
    # Composite (BSpline+ECLARE) caused catastrophic failures on thick-slice
    # data (e.g., t2f with 6mm through-plane in MenGrowth-0002-000 produced
    # completely black output). ECLARE is fragile for extreme anisotropy
    # (>5mm) and near-isotropic edge cases. BSpline order=3 blurs slightly
    # at large upsampling factors but is robust and deterministic.
    #
    # FUTURE: Re-enable composite after ECLARE robustness is improved, or
    # use composite only for modalities with moderate anisotropy (1.5-5mm).
    resampling:
      save_visualization: true

      resampling:
        method: bspline                # CHANGED: was "composite". BSpline is robust for all spacing ranges.
        target_voxel_size: [1.0, 1.0, 1.0]   # Isotropic 1mm³ (BraTS standard)

        # Pre-resampling normalization (applied BEFORE resampling to stabilize intensities)
        # null is recommended — normalization happens at step 7 after skull stripping.
        normalize_method: null

        # ── BSpline parameters (used by composite's interpolation stage) ──
        bspline_order: 3               # 3 = cubic (recommended). 0=NN, 1=linear, 5=quintic.

        # ── ECLARE parameters (used by composite's DL stage) ──
        conda_environment_eclare: "mengrowth"  # ECLARE is in the same env as the pipeline
        batch_size: 128                      # GPU memory vs speed. 128 = good default for A100.
        n_patches: 80000                     # Patches sampled from volume. 80k = good for single volume.
        patch_sampling: "gradient"           # "gradient" = preferentially sample edges (better structure preservation)
        suffix: ""
        gpu_id: 0                            # GPU device ID. Use [0,1] for multi-GPU if available.

        # ── Composite routing thresholds ──
        composite_interpolator: "bspline"    # BSpline for the interpolation stage
        composite_dl_method: "eclare"        # ECLARE for the DL stage

        # Decision boundaries (see header comments for full logic):
        max_mm_interpolator: 1.5             # BSpline-only for spacing ≤ 1.5mm
        max_mm_dl_method: 5.0                # ECLARE for spacing ≤ 5.0mm
        resample_mm_to_interpolator_if_max_mm_dl_method: 3.5   # Pre-resample very thick slabs to 3.5mm before ECLARE

        # Unused normalization params (kept for config compatibility)
        norm_value: 1.0
        p1: 1.0
        p2: 99.0
        whitestripe_width: 0.05
        whitestripe_width_l: null
        whitestripe_width_u: null
        fcm_n_clusters: 3
        fcm_tissue_type: "WM"
        fcm_max_iter: 50
        fcm_error_threshold: 0.005
        fcm_fuzziness: 2.0

    # ========================================================================
    # Step 4: Cubic Padding (study-level)
    # ========================================================================
    # Pads all modalities to the same cubic FOV. Prevents edge clipping during
    # registration affine transforms and normalizes FOV across modalities.
    # No changes from v1 — these are the right defaults.
    #
    # fill_value_mode="min": Uses each image's minimum intensity (matches air/background).
    #   After skull stripping this would be 0, but padding happens BEFORE skull stripping.
    # target_shape_mode="max_across_modalities": All modalities get the same cubic size.
    #   Critical for multi-modal registration (same grid = faster, no resampling).
    cubic_padding:
      save_visualization: true

      cubic_padding:
        method: "symmetric"                  # Center brain, equal padding both sides.
        fill_value_mode: "min"               # "min" | "zero". "min" matches background level.
        target_shape_mode: "max_across_modalities"   # "max_across_modalities" | "max_per_modality"

    # ========================================================================
    # Step 5: Skull Stripping (study-level)                 *** NOW BEFORE REGISTRATION ***
    # ========================================================================
    # Brain extraction using HD-BET with consensus masking across modalities.
    # Now runs BEFORE registration so that registration operates on brain-only volumes.
    #
    # HD-BET accurate + TTA: Ensemble of 5 U-Nets × 5 mirror augmentations = 25 predictions
    #   averaged. ~30s/volume but highest quality. Robust to tumors, edema, resection.
    #   For faster iteration, switch to hdbet_mode: "fast" (~5s/volume, single model).
    #
    # Consensus masking: When multiple modalities exist (T1c, T1n, T2w, T2f), each
    #   gets its own brain mask. The consensus mask = majority vote (≥ threshold modalities
    #   agree voxel is brain). More robust than single-modality, especially at brain edges
    #   where T1/T2 contrast differs.
    #
    # consensus_threshold=2: At least 2 of 4 modalities must agree. Conservative.
    #   With 4 modalities, 2 = generous (includes borderline voxels).
    #   Set to 3 for tighter masks (excludes meningioma periphery in some cases).
    skull_stripping:
      save_visualization: true
      save_mask: true                  # Save brain mask to artifacts (used by intensity normalization)

      skull_stripping:
          method: "hdbet"              # "hdbet" | "synthstrip". HD-BET for pathological brains.
          fill_value: 0.0              # Background after masking. 0 is standard.

          consensus_masking: true      # Highly recommended with multiple modalities.
          consensus_threshold: 2       # [1-N_modalities]. 2/4 = conservative for meningioma.

          # HD-BET
          hdbet_mode: "accurate"       # "accurate" (ensemble+TTA) | "fast" (single model)
          hdbet_device: 0              # GPU id. Use "cpu" if no GPU.
          hdbet_do_tta: true           # Test-time augmentation (mirror predictions). Slower but better.

          # SynthStrip (unused when method="hdbet", kept for reference)
          synthstrip_border: 1
          synthstrip_device: 0

    # ========================================================================
    # Step 6: Registration (study-level)                    *** NOW AFTER SKULL STRIPPING ***
    # ========================================================================
    # Operates on brain-only volumes (background = 0 after skull stripping).
    #
    # CHANGED from v1:
    #   - interpolation: BSpline → Linear (for both intra-study and atlas)
    #     BSpline creates ringing at the brain→0 boundary (Gibbs-like artifact from
    #     4-voxel kernel spanning the discontinuity). Linear avoids this.
    #     For Rigid+Affine transforms, interior quality difference is negligible.
    #   - atlas_path: must point to brain-only atlas (T1_brain.nii)
    #     Full-head atlas + brain-only subject = metric mismatch = bad registration.
    #
    # Metric choice: Mattes MI is robust to zero-background and multi-modal contrast.
    #   Do NOT use CC (cross-correlation) — it's sensitive to zero regions.
    registration_static:
        save_visualization: true
        save_detailed_registration_info: true

        # ── Step 6a: Intra-study coregistration ──
        # Aligns T1c, T2w, T2f to reference (T1n preferred) within one timepoint.
        intra_study_to_reference:
          method: "ants"
          engine: "antspyx"                  # antspyx = faster than nipype
          save_detailed_registration_info: true
          reference_modality_priority: "t1n > t1c > t2f > t2w"

          # Rigid+Affine is appropriate for intra-study: accounts for patient motion
          # between sequences + minor geometric distortions. SyN would overfit.
          transform_type: ["Rigid", "Affine"]

          # Metric: Mattes MI handles multi-modal contrast and zero-background well.
          # metric_bins=64: Good balance. 32 for noisy data, 128 for high-quality.
          metric: "Mattes"
          metric_bins: 64
          sampling_strategy: "Random"
          sampling_percentage: 0.5           # 50% of voxels. Increase to 0.75 if registration is unstable.

          # Multi-resolution: 4 levels, coarse-to-fine.
          # The 0 at level 4 for both transforms means we skip full-res refinement.
          # This is a speed optimization — Rigid+Affine converges before full-res.
          number_of_iterations: [[1000, 500, 250, 0], [1000, 500, 250, 0]]
          shrink_factors: [[8, 4, 2, 1], [8, 4, 2, 1]]
          smoothing_sigmas: [[3, 2, 1, 0], [3, 2, 1, 0]]

          convergence_threshold: 1.0e-6
          convergence_window_size: 10

          write_composite_transform: true
          interpolation: "Linear"            # CHANGED: was "BSpline". Avoids ringing at brain boundary.

          use_center_of_mass_init: true      # Pre-align centroids. Important for brain-only volumes.
          validate_registration_quality: true
          quality_warning_threshold: -0.3

        # ── Step 6b: Atlas registration ──
        # Registers reference modality to SRI24 atlas space.
        # All other modalities are propagated via composite transforms.
        intra_study_to_atlas:
          method: "ants"
          engine: "antspyx"
          save_detailed_registration_info: true

          # CHANGED: Must be brain-only atlas since subjects are skull-stripped.
          # If T1_brain.nii doesn't exist, skull-strip T1.nii once with HD-BET.
          atlas_path: "/mnt/home/users/tic_163_uma/mpascual/fscratch/datasets/meningiomas/sri24_atlas/T1_brain.nii"

          transforms: ["Rigid", "Affine"]
          create_composite_transforms: false

          # MI with 128 bins: atlas registration benefits from more precise metric
          # since the atlas is high-quality and we want accurate spatial normalization.
          metric: "MI"
          metric_bins: 128
          sampling_strategy: "Random"
          sampling_percentage: 0.5

          # More aggressive schedule for atlas registration (inter-subject alignment
          # requires more iterations than intra-study).
          number_of_iterations: [[2000, 1000, 500, 250], [1000, 500, 250, 100]]
          shrink_factors: [[8, 4, 2, 1], [4, 2, 1, 1]]
          smoothing_sigmas: [[4, 2, 1, 0], [2, 1, 0, 0]]

          convergence_threshold: 1.0e-6
          convergence_window_size: 10

          interpolation: "Linear"            # CHANGED: was "BSpline". Same brain-boundary rationale.

          use_center_of_mass_init: true
          validate_registration_quality: true
          quality_warning_threshold: -0.3

    # ========================================================================
    # Step 7: Intensity Normalization (modality-level)           *** CHANGED ***
    # ========================================================================
    # CHANGED: method=null (disabled). Z-score normalization will be done
    # on-the-fly in the training dataloader instead.
    #
    # Rationale: In the skull-strip-first pipeline, the brain mask from
    # skull stripping may not perfectly align with the brain after atlas
    # registration. Z-score normalization within the mask creates a visible
    # shadow/boundary artifact at mask edges. Deferring normalization to
    # training time avoids this artifact and allows per-sample statistics.
    #
    # save_visualization=true still generates a passthrough snapshot
    # (3 views + histogram) for QC without modifying the data.
    intensity_normalization:
      save_visualization: true

      intensity_normalization:
          method: null                       # CHANGED: was "zscore". Normalize on-the-fly in dataloader.
          norm_value: 1.0
          clip_range: [-5.0, 5.0]

          # Unused params (kept for config compatibility)
          p1: 1.0
          p2: 99.0
          width: 0.05
          width_l: null
          width_u: null
          n_clusters: 3
          tissue_type: "WM"
          max_iter: 50
          error_threshold: 0.005
          fuzziness: 2.0

    # ========================================================================
    # Step 8: Longitudinal Registration (patient-level)
    # ========================================================================
    # Aligns timepoints for each patient to a reference timestamp.
    # BSpline interpolation is kept here — interior accuracy matters for
    # growth measurement, and both fixed/moving are already skull-stripped
    # so any boundary artifacts are at the brain edge (not clinically relevant
    # for tumor volumetry).
    longitudinal_registration:
      save_visualization: true

      longitudinal_registration:
          method: "ants"
          engine: "antspyx"

          # Single-reference mode: all modalities → reference modality from ref timestamp.
          # Alternative: "per_modality" registers each modality independently (T1c→T1c, T2w→T2w).
          # per_modality may be better for growth tracking where each contrast has independent value.
          reference_modality_priority: "t1n > t1c > t2f > t2w"

          reference_timestamp_per_study: "configs/picasso/longitudinal_registration_matches.yaml"

          # Quality-based automatic reference selection
          reference_selection_method: "quality_based"
          reference_selection_metrics:
            - "snr_foreground"
            - "cnr_high_low"
            - "boundary_gradient_score"
            - "brain_coverage_fraction"
            - "laplacian_sharpness"
            - "ghosting_score"
          reference_selection_prefer_earlier: true
          reference_selection_validate_jacobian: true
          reference_selection_jacobian_threshold: 0.5

          transform_type: ["Rigid", "Affine"]

          # Mattes MI: robust for same-modality longitudinal (handles contrast agent
          # differences across timepoints). CC would also work but is less robust
          # to acquisition parameter changes between visits.
          metric: "Mattes"
          metric_bins: 64
          sampling_strategy: "Random"
          sampling_percentage: 0.5

          number_of_iterations: [[1000, 500, 250, 0], [1000, 500, 250, 0]]
          shrink_factors: [[8, 4, 2, 1], [8, 4, 2, 1]]
          smoothing_sigmas: [[3, 2, 1, 0], [3, 2, 1, 0]]

          convergence_threshold: 1.0e-6
          convergence_window_size: 10
          write_composite_transform: true

          # BSpline for longitudinal: interior accuracy is critical for measuring
          # tumor growth between timepoints. Boundary artifacts are negligible
          # compared to the clinical value of sharp interior registration.
          interpolation: "BSpline"

          save_detailed_registration_info: false

          # Mask propagation: warp reference brain mask to other timestamps for QC
          propagate_reference_mask: true
          compute_mask_comparison: true

  # ============================================================================
  # Per-step QC Metrics
  # ============================================================================
  # Note: compute_after_steps order updated to match new step order.
  qc_metrics:
    enabled: true
    output_dir: "/mnt/home/users/tic_163_uma/mpascual/execs/mengrowth-dataset/qc_v2"
    artifacts_dir: "/mnt/home/users/tic_163_uma/mpascual/execs/mengrowth-dataset/qc_v2/artifacts"
    overwrite: true

    compute_after_steps:
      - "data_harmonization"
      - "bias_field_correction"
      - "resampling"
      - "skull_stripping"            # Now before registration
      - "registration_static"        # Now after skull_stripping
      - "intensity_normalization"
      - "longitudinal_registration"

    downsample_to_mm: 2.0
    max_voxels: 250000
    random_seed: 1234
    mask_source: "skullstrip_else_otsu"

    outlier_detection:
      enabled: true
      method: "mad"
      mad_threshold: 3.5
      iqr_multiplier: 3.0

    metrics:
      geometry:
        enabled: true
        check_orientation: true
        check_spacing: true
        check_affine_det: true

      registration_similarity:
        enabled: true
        nmi_multimodal: true
        ncc_longitudinal: true
        use_mask: true

      mask_plausibility:
        enabled: true
        check_volume: true
        boundary_gradient_score: true
        longitudinal_dice: true

      intensity_stability:
        enabled: true
        median_iqr: true
        wasserstein_distance: true
        reference_mode: "site_modality"
        histogram_bins: 256
        histogram_range_percentiles: [0.5, 99.5]

      snr_cnr:
        enabled: true
        background_percentile: 5.0
        foreground_percentile: 75.0
        edge_erosion_iters: 3
        intensity_low_pct: 25.0
        intensity_mid_pct: 50.0
        intensity_high_pct: 75.0

      baseline:
        enabled: true
        capture_before_first_step: true
        metrics_to_capture: ["geometry", "intensity", "snr_cnr"]

      comparison:
        enabled: true
        compute_deltas: true
        compute_ratios: true
        flag_degradation_threshold_pct: 10.0

    outputs:
      save_long_csv: true
      save_wide_csv: true
      save_summary_csv: true
      save_metadata_json: true

  # ============================================================================
  # Checkpoints
  # ============================================================================
  checkpoints:
    enabled: true
    checkpoint_dir: "/mnt/home/users/tic_163_uma/mpascual/execs/mengrowth-dataset/checkpoints_v2"

  # ============================================================================
  # Post-processing Quality Analysis
  # ============================================================================
  quality_analysis:
    input_dir: "/mnt/home/users/tic_163_uma/mpascual/fscratch/datasets/meningiomas/dataset/preprocessed_v2"
    output_dir: "/mnt/home/users/tic_163_uma/mpascual/execs/mengrowth-dataset/qa_reports_v2"
    file_format: "nifti"
    expected_sequences: ["t1c", "t1n", "t2w", "t2f"]

    metrics:
      patient_statistics: true
      missing_sequences: true
      voxel_spacing: true
      intensity_statistics: true
      image_dimensions: true
      acquisition_consistency: true
      snr_estimation: true

    outlier_detection:
      enabled: true
      method: "iqr"
      iqr_multiplier: 1.5
      zscore_threshold: 3.0

    visualization:
      enabled: true
      plots:
        studies_per_patient_histogram: true
        missing_sequences_heatmap: true
        spacing_violin_plots: true
        intensity_boxplots: true
        dimension_consistency_scatter: true
        snr_distribution: true
      html_report:
        enabled: true
        title: "MenGrowth Preprocessing Quality Report (v2 — skull-strip-first)"

    output:
      save_per_study_csv: true
      save_per_patient_csv: true
      save_summary_json: true
