# ============================================================================
# MenGrowth Preprocessing — Picasso v3 (register-first, BraTS-standard skull stripping)
# ============================================================================
#
# Key changes from v2:
#   1. Step order: registration BEFORE skull_stripping (reverted to v1 order)
#      Rationale: Per-modality skull stripping before registration clips tumor
#      tissue on T2f/FLAIR for extra-axial meningiomas (HD-BET optimized for T1w).
#      Registering full-head volumes first gives MI good landmarks from scalp/skull.
#
#   2. Skull stripping: reference_mask_modality = "t1c" (BraTS-standard)
#      Only T1c is skull-stripped; its brain mask is applied to all co-registered
#      modalities. Ensures consistent masking and retains full tumor extent on T2f.
#
#   3. Registration interpolation: BSpline (no brain boundary discontinuity)
#      Full-head input means no sharp brain→0 boundary, so BSpline ringing is
#      not a concern. BSpline gives better interior quality than Linear.
#
#   4. Atlas: full-head T1.nii (matches full-head subject input)
#      No metric mismatch — both subject and atlas have skull/scalp.
#
#   5. Intensity normalization: disabled (defer to training dataloader)
#      Z-score on-the-fly avoids mask-edge artifacts and allows per-sample stats.
#
# ============================================================================

preprocessing:
  # ── Pipeline step order ──
  # v2: ... skull_stripping → registration ...
  # v3: ... registration → skull_stripping ...   (BraTS-standard)
  steps: ["data_harmonization",
          "bias_field_correction",
          "resampling",
          "cubic_padding",
          "registration_static",
          "skull_stripping",
          "intensity_normalization",
          "longitudinal_registration"
          ]

  general_configuration:
    enabled: true

    # Selection
    patient_selector: "all"        # "single" | "all"
    patient_id: "MenGrowth-0006"   # used only if patient_selector == "single"

    # I/O mode
    mode: "test"                       # "test" | "pipeline"
    dataset_root: "/mnt/home/users/tic_163_uma/mpascual/fscratch/datasets/meningiomas/dataset/MenGrowth-2025"
    output_root: "/mnt/home/users/tic_163_uma/mpascual/fscratch/datasets/meningiomas/dataset/preprocecessed/MenGrowth-2025"
    preprocessing_artifacts_path: "/mnt/home/users/tic_163_uma/mpascual/fscratch/datasets/meningiomas/dataset/preprocecessed/artifacts"
    viz_root: "/mnt/home/users/tic_163_uma/mpascual/fscratch/datasets/meningiomas/dataset/preprocecessed/visualizations"
    overwrite: true

    # Modalities to include (if present in a study directory)
    modalities: ["t1c", "t1n", "t2w", "t2f"]

    # Detailed patient archive (HDF5 snapshots for showcase patients)
    detailed_archive:
      enabled: true
      patient_ids: ["MenGrowth-0009"]
      compression: "gzip"
      compression_level: 4

  # ============================================================================
  # Step-specific configurations
  # ============================================================================
  step_configs:

    # ========================================================================
    # Step 1: Data Harmonization (modality-level)
    # ========================================================================
    # NRRD → NIfTI conversion, RAS reorientation, optional background removal.
    # background_zeroing is null — skull stripping handles brain extraction.
    data_harmonization:
      save_visualization: true

      reorient_to: "RAS"                 # Standard for ANTs. "LPS" for ITK convention.

      background_zeroing:
        method: null                     # null = skip (let skull stripping handle brain extraction)

        # Parameters below are inactive when method=null but kept for reference.
        percentile_low: 2
        gaussian_sigma: 0.5
        min_comp_voxels: 500
        auto_fallback: true
        fallback_threshold: 0.05
        fallback_method: "otsu"
        fallback_percentile: 10.0
        fill_value: 0.0
        air_p_low: 2.0
        air_p_high: 20.0
        air_p_global: 0.2
        erode_vox: 1
        close_iters: 2
        connectivity: 2
        air_border_margin: 0
        expand_air_mask: 3
        gaussian_sigma_px: 1.0
        n_components_to_keep: 1
        relaxed_threshold_factor: 0.1
        p_low: 1.0
        p_high: 99.0

    # ========================================================================
    # Step 2: Bias Field Correction (modality-level)
    # ========================================================================
    # N4ITK removes low-frequency intensity non-uniformity (RF coil inhomogeneity).
    # Parameters are ITK recommended defaults — no changes needed.
    #
    # shrink_factor=4: Downsample 4x for speed. The bias field is spatially smooth
    #   so 4x is fine. Increase to 2 for very small FOV or high-quality requirement.
    # max_iterations=[50,50,50,50]: 4 resolution levels, 50 iters each. Standard.
    # bias_field_fwhm=0.15: Controls smoothness of the estimated bias field.
    #   Higher = smoother field, prevents overfitting. 0.15 is conservative.
    # convergence_threshold=0.001: Stop if field change < 0.1%. Standard.
    bias_field_correction:
      save_visualization: true
      save_artifact: true              # Useful for QC: inspect the estimated bias field

      bias_field_correction:
        method: "n4"                   # Only option. Set null to skip entirely.
        shrink_factor: 4               # [1-8]. 4 = standard. 2 = more precise, 2x slower.
        max_iterations: [50, 50, 50, 50]   # Per-level. More = diminishing returns.
        bias_field_fwhm: 0.15          # [0.01-1.0]. 0.15 = standard for brain MRI.
        convergence_threshold: 0.001   # [0.0001-0.01]. 0.001 = standard.

    # ========================================================================
    # Step 3: Resampling (modality-level)
    # ========================================================================
    # BSpline order=3 for isotropic resampling. Robust for all spacing ranges.
    # ECLARE/composite disabled due to catastrophic failures on thick-slice data.
    resampling:
      save_visualization: true

      resampling:
        method: bspline                # BSpline is robust for all spacing ranges.
        target_voxel_size: [1.0, 1.0, 1.0]   # Isotropic 1mm³ (BraTS standard)

        # Pre-resampling normalization (applied BEFORE resampling to stabilize intensities)
        # null is recommended — normalization happens at step 7 after skull stripping.
        normalize_method: null

        # ── BSpline parameters ──
        bspline_order: 3               # 3 = cubic (recommended). 0=NN, 1=linear, 5=quintic.

        # ── ECLARE parameters (inactive when method=bspline, kept for reference) ──
        conda_environment_eclare: "mengrowth"
        batch_size: 128
        n_patches: 80000
        patch_sampling: "gradient"
        suffix: ""
        gpu_id: 0

        # ── Composite routing thresholds ──
        composite_interpolator: "bspline"
        composite_dl_method: "eclare"

        max_mm_interpolator: 1.5
        max_mm_dl_method: 5.0
        resample_mm_to_interpolator_if_max_mm_dl_method: 3.5

        # Unused normalization params (kept for config compatibility)
        norm_value: 1.0
        p1: 1.0
        p2: 99.0
        whitestripe_width: 0.05
        whitestripe_width_l: null
        whitestripe_width_u: null
        fcm_n_clusters: 3
        fcm_tissue_type: "WM"
        fcm_max_iter: 50
        fcm_error_threshold: 0.005
        fcm_fuzziness: 2.0

    # ========================================================================
    # Step 4: Cubic Padding (study-level)
    # ========================================================================
    # Pads all modalities to the same cubic FOV. Prevents edge clipping during
    # registration affine transforms and normalizes FOV across modalities.
    #
    # fill_value_mode="zero": Always pad with 0. Avoids negative fill from N4.
    # target_shape_mode="max_across_modalities": All modalities get the same cubic size.
    #   Critical for multi-modal registration (same grid = faster, no resampling).
    cubic_padding:
      save_visualization: true

      cubic_padding:
        method: "symmetric"                  # Center brain, equal padding both sides.
        fill_value_mode: "zero"              # Zero avoids negative fill from N4.
        target_shape_mode: "max_across_modalities"   # "max_across_modalities" | "max_per_modality"

    # ========================================================================
    # Step 5: Registration (study-level)                    *** NOW BEFORE SKULL STRIPPING ***
    # ========================================================================
    # Operates on full-head volumes (skull stripping has not run yet).
    #
    # v3 changes:
    #   - interpolation: BSpline (full-head input has no brain→0 discontinuity)
    #   - atlas_path: T1.nii (full-head atlas matches full-head subject)
    #
    # Metric choice: Mattes MI is robust for multi-modal contrast.
    registration_static:
        save_visualization: true
        save_detailed_registration_info: true

        # ── Step 5a: Intra-study coregistration ──
        # Aligns T1c, T2w, T2f to reference (T1n preferred) within one timepoint.
        intra_study_to_reference:
          method: "ants"
          engine: "antspyx"                  # antspyx = faster than nipype
          save_detailed_registration_info: true
          reference_modality_priority: "t1n > t1c > t2f > t2w"

          # Rigid+Affine is appropriate for intra-study: accounts for patient motion
          # between sequences + minor geometric distortions. SyN would overfit.
          transform_type: ["Rigid", "Affine"]

          # Metric: Mattes MI handles multi-modal contrast well.
          # metric_bins=64: Good balance. 32 for noisy data, 128 for high-quality.
          metric: "Mattes"
          metric_bins: 64
          sampling_strategy: "Random"
          sampling_percentage: 0.5           # 50% of voxels. Increase to 0.75 if registration is unstable.

          # Multi-resolution: 4 levels, coarse-to-fine.
          number_of_iterations: [[1000, 500, 250, 0], [1000, 500, 250, 0]]
          shrink_factors: [[8, 4, 2, 1], [8, 4, 2, 1]]
          smoothing_sigmas: [[3, 2, 1, 0], [3, 2, 1, 0]]

          convergence_threshold: 1.0e-6
          convergence_window_size: 10

          write_composite_transform: true
          interpolation: "BSpline"           # Full-head input: no brain boundary ringing.

          use_center_of_mass_init: true
          validate_registration_quality: true
          quality_warning_threshold: -0.3

        # ── Step 5b: Atlas registration ──
        # Registers reference modality to SRI24 atlas space.
        # All other modalities are propagated via composite transforms.
        intra_study_to_atlas:
          method: "ants"
          engine: "antspyx"
          save_detailed_registration_info: true

          # Full-head atlas (T1.nii) matches full-head subject input.
          atlas_path: "/mnt/home/users/tic_163_uma/mpascual/fscratch/datasets/meningiomas/sri24_atlas/T1.nii"

          transforms: ["Rigid", "Affine"]
          create_composite_transforms: false

          # MI with 128 bins: atlas registration benefits from more precise metric
          # since the atlas is high-quality and we want accurate spatial normalization.
          metric: "MI"
          metric_bins: 128
          sampling_strategy: "Random"
          sampling_percentage: 0.5

          # More aggressive schedule for atlas registration (inter-subject alignment
          # requires more iterations than intra-study).
          number_of_iterations: [[2000, 1000, 500, 250], [1000, 500, 250, 100]]
          shrink_factors: [[8, 4, 2, 1], [4, 2, 1, 1]]
          smoothing_sigmas: [[4, 2, 1, 0], [2, 1, 0, 0]]

          convergence_threshold: 1.0e-6
          convergence_window_size: 10

          interpolation: "BSpline"           # Full-head input: no brain boundary ringing.

          use_center_of_mass_init: true
          validate_registration_quality: true
          quality_warning_threshold: -0.3

    # ========================================================================
    # Step 6: Skull Stripping (study-level)                 *** NOW AFTER REGISTRATION ***
    # ========================================================================
    # BraTS-standard approach: skull-strip T1c only, apply its mask to all
    # co-registered modalities. Ensures consistent masking and retains full
    # tumor extent on T2f (HD-BET clips extra-axial tumors on FLAIR).
    #
    # HD-BET accurate + TTA: Ensemble of 5 U-Nets × 5 mirror augmentations = 25
    #   predictions averaged. ~30s/volume but highest quality.
    skull_stripping:
      save_visualization: true
      save_mask: true                  # Save brain mask to artifacts (used by intensity normalization)

      skull_stripping:
          method: "hdbet"              # "hdbet" | "synthstrip". HD-BET for pathological brains.
          fill_value: 0.0              # Background after masking. 0 is standard.

          # BraTS-standard: T1c mask for all co-registered modalities
          reference_mask_modality: "t1c"

          # Consensus disabled (irrelevant with reference_mask_modality)
          consensus_masking: false
          consensus_threshold: 2

          # HD-BET
          hdbet_mode: "accurate"       # "accurate" (ensemble+TTA) | "fast" (single model)
          hdbet_device: 0              # GPU id. Use "cpu" if no GPU.
          hdbet_do_tta: true           # Test-time augmentation (mirror predictions). Slower but better.

          # SynthStrip (unused when method="hdbet", kept for reference)
          synthstrip_border: 1
          synthstrip_device: 0

    # ========================================================================
    # Step 7: Intensity Normalization (modality-level)
    # ========================================================================
    # Disabled: z-score normalization deferred to training dataloader.
    # save_visualization=true still generates a passthrough snapshot for QC.
    intensity_normalization:
      save_visualization: true

      intensity_normalization:
          method: null                       # Normalize on-the-fly in dataloader.
          norm_value: 1.0
          clip_range: [-5.0, 5.0]

          # Unused params (kept for config compatibility)
          p1: 1.0
          p2: 99.0
          width: 0.05
          width_l: null
          width_u: null
          n_clusters: 3
          tissue_type: "WM"
          max_iter: 50
          error_threshold: 0.005
          fuzziness: 2.0

    # ========================================================================
    # Step 8: Longitudinal Registration (patient-level)
    # ========================================================================
    # Aligns timepoints for each patient to a reference timestamp.
    # BSpline interpolation is kept here — interior accuracy matters for
    # growth measurement, and both fixed/moving are already skull-stripped
    # so any boundary artifacts are at the brain edge (not clinically relevant
    # for tumor volumetry).
    longitudinal_registration:
      save_visualization: true

      longitudinal_registration:
          method: "ants"
          engine: "antspyx"

          reference_modality_priority: "t1n > t1c > t2f > t2w"

          reference_timestamp_per_study: "configs/picasso/longitudinal_registration_matches.yaml"

          # Quality-based automatic reference selection
          reference_selection_method: "quality_based"
          reference_selection_metrics:
            - "snr_foreground"
            - "cnr_high_low"
            - "boundary_gradient_score"
            - "brain_coverage_fraction"
            - "laplacian_sharpness"
            - "ghosting_score"
          reference_selection_prefer_earlier: true
          reference_selection_validate_jacobian: true
          reference_selection_jacobian_threshold: 0.5

          transform_type: ["Rigid", "Affine"]

          metric: "Mattes"
          metric_bins: 64
          sampling_strategy: "Random"
          sampling_percentage: 0.5

          number_of_iterations: [[1000, 500, 250, 0], [1000, 500, 250, 0]]
          shrink_factors: [[8, 4, 2, 1], [8, 4, 2, 1]]
          smoothing_sigmas: [[3, 2, 1, 0], [3, 2, 1, 0]]

          convergence_threshold: 1.0e-6
          convergence_window_size: 10
          write_composite_transform: true

          # BSpline for longitudinal: interior accuracy is critical for measuring
          # tumor growth between timepoints.
          interpolation: "BSpline"

          save_detailed_registration_info: false

          # Mask propagation: warp reference brain mask to other timestamps for QC
          propagate_reference_mask: true
          compute_mask_comparison: true

  # ============================================================================
  # Per-step QC Metrics
  # ============================================================================
  qc_metrics:
    enabled: true
    output_dir: "/mnt/home/users/tic_163_uma/mpascual/fscratch/datasets/meningiomas/dataset/preprocecessed/quality"
    artifacts_dir: "/mnt/home/users/tic_163_uma/mpascual/fscratch/datasets/meningiomas/dataset/preprocecessed/quality/artifacts"
    overwrite: true

    compute_after_steps:
      - "data_harmonization"
      - "bias_field_correction"
      - "resampling"
      - "registration_static"        # Now before skull_stripping (v3)
      - "skull_stripping"            # Now after registration (v3)
      - "intensity_normalization"
      - "longitudinal_registration"

    downsample_to_mm: 2.0
    max_voxels: 250000
    random_seed: 1234
    mask_source: "skullstrip_else_otsu"

    outlier_detection:
      enabled: true
      method: "mad"
      mad_threshold: 3.5
      iqr_multiplier: 3.0

    metrics:
      geometry:
        enabled: true
        check_orientation: true
        check_spacing: true
        check_affine_det: true

      registration_similarity:
        enabled: true
        nmi_multimodal: true
        ncc_longitudinal: true
        use_mask: true

      mask_plausibility:
        enabled: true
        check_volume: true
        boundary_gradient_score: true
        longitudinal_dice: true

      intensity_stability:
        enabled: true
        median_iqr: true
        wasserstein_distance: true
        reference_mode: "site_modality"
        histogram_bins: 256
        histogram_range_percentiles: [0.5, 99.5]

      snr_cnr:
        enabled: true
        background_percentile: 5.0
        foreground_percentile: 75.0
        edge_erosion_iters: 3
        intensity_low_pct: 25.0
        intensity_mid_pct: 50.0
        intensity_high_pct: 75.0

      baseline:
        enabled: true
        capture_before_first_step: true
        metrics_to_capture: ["geometry", "intensity", "snr_cnr"]

      comparison:
        enabled: true
        compute_deltas: true
        compute_ratios: true
        flag_degradation_threshold_pct: 10.0

    outputs:
      save_long_csv: true
      save_wide_csv: true
      save_summary_csv: true
      save_metadata_json: true

  # ============================================================================
  # Checkpoints
  # ============================================================================
  checkpoints:
    enabled: true
    checkpoint_dir: "/mnt/home/users/tic_163_uma/mpascual/fscratch/datasets/meningiomas/dataset/preprocecessed/checkpoints"

  # ============================================================================
  # Post-processing Quality Analysis
  # ============================================================================
  quality_analysis:
    input_dir: "/mnt/home/users/tic_163_uma/mpascual/fscratch/datasets/meningiomas/dataset/preprocecessed/MenGrowth-2025"
    output_dir: "/mnt/home/users/tic_163_uma/mpascual/fscratch/datasets/meningiomas/dataset/preprocecessed/qa_reports"
    file_format: "nifti"
    expected_sequences: ["t1c", "t1n", "t2w", "t2f"]

    metrics:
      patient_statistics: true
      missing_sequences: true
      voxel_spacing: true
      intensity_statistics: true
      image_dimensions: true
      acquisition_consistency: true
      snr_estimation: true

    outlier_detection:
      enabled: true
      method: "iqr"
      iqr_multiplier: 1.5
      zscore_threshold: 3.0

    visualization:
      enabled: true
      plots:
        studies_per_patient_histogram: true
        missing_sequences_heatmap: true
        spacing_violin_plots: true
        intensity_boxplots: true
        dimension_consistency_scatter: true
        snr_distribution: true
      html_report:
        enabled: true
        title: "MenGrowth Preprocessing Quality Report (v3 — register-first, BraTS skull stripping)"

    output:
      save_per_study_csv: true
      save_per_patient_csv: true
      save_summary_json: true
